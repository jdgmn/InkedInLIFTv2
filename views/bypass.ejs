<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bypass Email Verification | InkedInLIFTv2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <%- include('partials/header', { title: 'Bypass Email Verification' }) %>

  <h1>Bypass Email Verification</h1>
  <p class="text-muted">List of unverified users. Click "Reveal Token" to show the verification link.</p>

  <div id="usersList" class="mb-4">
    <div class="text-center">Loading...</div>
  </div>

  <script>
  (async () => {
    const usersList = document.getElementById("usersList");

    async function loadUnverifiedUsers() {
      try {
        const res = await fetch("/api/users/unverified");
        if (!res.ok) {
          usersList.innerHTML = `<div class="alert alert-danger">Failed to load users (${res.status})</div>`;
          return;
        }
        const users = await res.json();
        if (users.length === 0) {
          usersList.innerHTML = `<div class="alert alert-info">No unverified users found.</div>`;
          return;
        }
        const html = users.map(user => `
          <div class="card mb-2">
            <div class="card-body">
              <h6 class="card-title">${user.firstName} ${user.lastName} (${user.email})</h6>
              <button class="btn btn-sm btn-outline-primary revealBtn" data-token="${user.verificationToken}">Reveal Token</button>
              <div class="tokenDisplay mt-2" style="display:none;"></div>
            </div>
          </div>
        `).join("");
        usersList.innerHTML = html;

        // Attach reveal handlers
        document.querySelectorAll(".revealBtn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const token = e.target.dataset.token;
            const displayDiv = e.target.nextElementSibling;
            const baseUrl = window.location.origin;
            const verifyLink = `${baseUrl}/api/users/verify/${token}`;
            displayDiv.innerHTML = `<small class="text-muted">Verification Link: <a href="${verifyLink}" target="_blank">${verifyLink}</a></small>`;
            displayDiv.style.display = "block";
            e.target.style.display = "none"; // Hide button after reveal
          });
        });
      } catch (err) {
        usersList.innerHTML = `<div class="alert alert-danger">Error loading users: ${err.message}</div>`;
      }
    }

    loadUnverifiedUsers();
  })();
  </script>

  <%- include('partials/footer') %>
</body>
</html>
