<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Memberships | InkedInLIFT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">InkedInLIFT</a>
      <div class="navbar-nav">
        <a class="nav-link" href="/dashboard">Dashboard</a>
        <a class="nav-link" href="/users">Users</a>
        <a class="nav-link" href="/memberships">Memberships</a>
        <a class="nav-link" href="/checkins">Check-ins</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1>Memberships</h1>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Create membership</h5>
        <form id="createMembershipForm" class="row g-2">
          <div class="col-12 col-md-4">
            <input id="memEmail" class="form-control" placeholder="User email" required />
          </div>
          <div class="col-12 col-md-3">
            <select id="memType" class="form-select" required>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="annual">Annual</option>
            </select>
          </div>
          <div class="col-12 col-md-2">
            <input id="memPrice" type="number" step="0.01" class="form-control" placeholder="Price" required />
          </div>
          <div class="col-12 col-md-2">
            <select id="memPayment" class="form-select">
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div class="col-12 col-md-1">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </form>
        <div id="createMsg" class="mt-2"></div>
      </div>
    </div>

    <table class="table table-striped">
      <thead>
        <tr><th>Member</th><th>Plan</th><th>Price</th><th>End Date</th><th>Status</th></tr>
      </thead>
      <tbody id="membersTableBody">
        <% memberships.forEach(function(m){ %>
          <tr>
            <td><%= (m.user && (m.user.firstName || m.user.lastName)) ? ((m.user.firstName||'') + ' ' + (m.user.lastName||'')).trim() : (m.user ? m.user.email : 'Unknown') %></td>
            <td><%= m.membershipType %></td>
            <td><%= m.price %></td>
            <td><%= m.endDate ? new Date(m.endDate).toLocaleDateString() : '' %></td>
            <td><%= m.status %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

<script>
  function getToken() {
    const t = localStorage.getItem("token");
    if (t) return t;
    const match = document.cookie.match(/(?:^|; )token=([^;]+)/);
    return match ? match[1] : null;
  }

  document.getElementById("createMembershipForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const token = getToken();
    if (!token) { alert("Not logged in. Log in as admin/receptionist."); return; }

    const payload = {
      email: document.getElementById("memEmail").value.trim(),
      membershipType: document.getElementById("memType").value,
      price: parseFloat(document.getElementById("memPrice").value),
      paymentStatus: document.getElementById("memPayment").value
    };

    const res = await fetch("/api/memberships", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    const msgEl = document.getElementById("createMsg");
    if (!res.ok) {
      msgEl.innerText = data.error || (data.message || "Failed");
      msgEl.className = "text-danger";
      return;
    }

    msgEl.innerText = data.message || "Membership created";
    msgEl.className = "text-success";
    // reload to show new membership
    setTimeout(()=> location.reload(), 700);
  });
</script>
</body>
</html>
