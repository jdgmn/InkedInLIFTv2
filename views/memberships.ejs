<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Memberships | InkedInLIFT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header', { title: 'Memberships' }) %>

  <h1>Memberships</h1>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Create membership</h5>
      <form id="createMembershipForm" class="row g-2">
        <div class="col-md-4">
          <input id="memEmail" class="form-control" placeholder="User email" list="emailList" required />
          <datalist id="emailList"></datalist>
        </div>
        <div class="col-md-3">
          <select id="memType" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div class="col-md-2"><input id="memPrice" type="number" step="0.01" class="form-control" placeholder="Price (₱)" required /></div>
        <div class="col-md-2">
          <select id="memPayment" class="form-select"><option value="paid">Paid</option><option value="pending">Pending</option><option value="failed">Failed</option></select>
        </div>
        <div class="col-md-1"><button class="btn btn-primary w-100">Add</button></div>
      </form>
      <div id="createMsg" class="mt-2"></div>
    </div>
  </div>

  <table class="table table-striped" id="membersTable">
    <thead><tr><th>Member</th><th>Plan</th><th>Price (₱)</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
  (async function(){
    function getToken(){ try{ const t=localStorage.getItem("token"); if(t) return t; }catch(e){} const m=document.cookie.match(/(?:^|; )token=([^;]+)/); return m?m[1]:null;}
    const token = getToken();
    const headersAuth = token ? { Authorization: "Bearer " + token } : {};
    const tbody = document.querySelector("#membersTable tbody");

    // Populate email suggestions
    async function populateEmailList() {
      try {
        const res = await fetch("/api/users");
        if (res.ok) {
          const users = await res.json();
          const emails = users.map(u => u.email);
          const datalist = document.getElementById("emailList");
          datalist.innerHTML = emails.map(email => `<option value="${email}">`).join("");
        }
      } catch (err) {
        console.error("Failed to load email suggestions:", err);
      }
    }
    populateEmailList();

    document.getElementById("createMembershipForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const payload = { email: document.getElementById("memEmail").value.trim(), membershipType: document.getElementById("memType").value, price: parseFloat(document.getElementById("memPrice").value), paymentStatus: document.getElementById("memPayment").value };
      const res = await fetch("/api/memberships", { method: "POST", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify(payload) });
      const data = await res.json();
      const msg = document.getElementById("createMsg");
      if (!res.ok) { msg.innerText = data.error || data.message || "Failed"; msg.className = "text-danger"; return; }
      msg.innerText = "Created"; msg.className = "text-success"; setTimeout(()=> load(), 600);
    });

    async function load(){
      tbody.innerHTML = "<tr><td colspan='6'>Loading…</td></tr>";
      const res = await fetch("/api/memberships", { headers: headersAuth });
      if (!res.ok) { tbody.innerHTML = "<tr><td colspan='6'>Failed to load</td></tr>"; return; }
      const items = await res.json();
      tbody.innerHTML = items.map(m => `<tr data-id="${m._id}"><td>${(m.user ? (m.user.firstName||'') + ' ' + (m.user.lastName||'') : (m.email||'Unknown')).trim()}</td><td>${m.membershipType}</td><td>₱${m.price}</td><td>${m.endDate ? new Date(m.endDate).toLocaleDateString() : ''}</td><td>${m.status}</td><td><button class="btn btn-sm btn-danger delBtn">Delete</button> <button class="btn btn-sm btn-primary editBtn">Edit</button></td></tr>`).join("");
      attach();
    }

    function attach(){
      document.querySelectorAll(".delBtn").forEach(b=>b.onclick=async (e)=>{ const id=e.target.closest("tr").dataset.id; if(!confirm("Delete membership?")) return; const res=await fetch("/api/memberships/" + id, { method: "DELETE", headers: headersAuth }); if (res.ok) load(); else alert("Delete failed"); });
      document.querySelectorAll(".editBtn").forEach(b=>b.onclick=async (e)=>{ const tr=e.target.closest("tr"); const id=tr.dataset.id; const currentStatus=tr.children[4].innerText; const newStatus=prompt("New status (active/expired/cancelled):", currentStatus); if(!newStatus || newStatus === currentStatus) return; const res=await fetch("/api/memberships/" + id, { method: "PUT", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify({ status: newStatus }) }); if (res.ok) load(); else alert("Update failed"); });
    }

    load();
  })();
  </script>

  <%- include('partials/footer') %>
</body>
</html>
