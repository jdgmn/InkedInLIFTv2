<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Memberships | InkedInLIFT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header', { title: 'Memberships' }) %>

  <h1>Memberships</h1>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Create membership</h5>
      <form id="createMembershipForm" class="row g-2">
        <div class="col-md-4">
          <input id="memEmail" class="form-control" placeholder="User email" list="emailList" required />
          <datalist id="emailList"></datalist>
        </div>
        <div class="col-md-3">
          <select id="memType" class="form-select">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="annual">Annual</option>
          </select>
        </div>
        <div class="col-md-2"><input id="memPrice" type="number" step="0.01" class="form-control" placeholder="Price (₱)" required /></div>
        <div class="col-md-2">
          <select id="memPayment" class="form-select"><option value="paid">Paid</option><option value="pending">Pending</option><option value="failed">Failed</option></select>
        </div>
        <div class="col-md-1"><button class="btn btn-primary w-100">Add</button></div>
      </form>
      <div id="createMsg" class="mt-2"></div>
    </div>
  </div>

  <table class="table table-striped" id="membersTable">
    <thead><tr><th>Member</th><th>Plan</th><th>Price (₱)</th><th>Payment</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
  (async function(){
    function getToken(){ try{ const t=localStorage.getItem("token"); if(t) return t; }catch(e){} const m=document.cookie.match(/(?:^|; )token=([^;]+)/); return m?m[1]:null;}
    const token = getToken();
    const headersAuth = token ? { Authorization: "Bearer " + token } : {};
    const tbody = document.querySelector("#membersTable tbody");

    // Populate email suggestions
    async function populateEmailList() {
      try {
        const res = await fetch("/api/users");
        if (res.ok) {
          const users = await res.json();
          const emails = users.map(u => u.email);
          const datalist = document.getElementById("emailList");
          datalist.innerHTML = emails.map(email => `<option value="${email}">`).join("");
        }
      } catch (err) {
        console.error("Failed to load email suggestions:", err);
      }
    }
    populateEmailList();

    document.getElementById("createMembershipForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const payload = { email: document.getElementById("memEmail").value.trim(), membershipType: document.getElementById("memType").value, price: parseFloat(document.getElementById("memPrice").value), paymentStatus: document.getElementById("memPayment").value };
      const res = await fetch("/api/memberships", { method: "POST", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify(payload) });
      const data = await res.json();
      const msg = document.getElementById("createMsg");
      if (!res.ok) { msg.innerText = data.error || data.message || "Failed"; msg.className = "text-danger"; return; }
      msg.innerText = "Created"; msg.className = "text-success"; setTimeout(()=> load(), 600);
    });

    async function load(){
      tbody.innerHTML = "<tr><td colspan='7'>Loading…</td></tr>";
      const res = await fetch("/api/memberships", { headers: headersAuth });
      if (!res.ok) { tbody.innerHTML = "<tr><td colspan='7'>Failed to load</td></tr>"; return; }
      const items = await res.json();
      tbody.innerHTML = items.map(m => `<tr data-id="${m._id}"><td>${(m.user ? (m.user.firstName||'') + ' ' + (m.user.lastName||'') : (m.email||'Unknown')).trim()}</td><td>${m.membershipType}</td><td>₱${m.price}</td><td>${m.paymentStatus}</td><td>${m.endDate ? new Date(m.endDate).toLocaleDateString() : ''}</td><td>${m.status}</td><td><button class="btn btn-sm btn-danger delBtn">Delete</button> <button class="btn btn-sm btn-primary editBtn">Edit</button></td></tr>`).join("");
      attach();
    }

    function attach(){
      document.querySelectorAll(".delBtn").forEach(b=>b.onclick=async (e)=>{ const id=e.target.closest("tr").dataset.id; if(!confirm("Delete membership?")) return; const res=await fetch("/api/memberships/" + id, { method: "DELETE", headers: headersAuth }); if (res.ok) load(); else alert("Delete failed"); });
      document.querySelectorAll(".editBtn").forEach(b=>b.onclick=async (e)=>{
        const tr=e.target.closest("tr");
        const id=tr.dataset.id;
        const membershipType = tr.children[1].innerText;
        const price = parseFloat(tr.children[2].innerText.replace('₱', ''));
        const paymentStatus = tr.children[3].innerText;
        const endDate = tr.children[4].innerText;
        const status = tr.children[5].innerText;

        // Populate modal
        document.getElementById("editMembershipType").value = membershipType;
        document.getElementById("editMembershipPrice").value = price;
        document.getElementById("editMembershipPayment").value = paymentStatus;
        document.getElementById("editMembershipStatus").value = status;
        document.getElementById("editMembershipStartDate").value = ""; // Optional
        document.getElementById("editMembershipMsg").innerText = "";

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById("editMembershipModal"));
        modal.show();

        // Handle save
        const saveBtn = document.getElementById("saveEditMembershipBtn");
        const handleSave = async () => {
          const payload = {
            membershipType: document.getElementById("editMembershipType").value,
            price: parseFloat(document.getElementById("editMembershipPrice").value),
            paymentStatus: document.getElementById("editMembershipPayment").value,
            status: document.getElementById("editMembershipStatus").value
          };
          const startDate = document.getElementById("editMembershipStartDate").value.trim();
          if (startDate) payload.startDate = startDate;

          const res = await fetch("/api/memberships/" + id, { method: "PUT", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) {
            document.getElementById("editMembershipMsg").innerText = data.error || "Update failed";
            document.getElementById("editMembershipMsg").className = "text-danger";
            return;
          }
          document.getElementById("editMembershipMsg").innerText = "Updated successfully";
          document.getElementById("editMembershipMsg").className = "text-success";
          modal.hide();
          load();
        };

        saveBtn.onclick = handleSave;

        // Clean up event listener when modal is hidden
        document.getElementById("editMembershipModal").addEventListener("hidden.bs.modal", () => {
          saveBtn.onclick = null;
        }, { once: true });
      });
    }

    load();
  })();
  </script>

  <!-- Edit Membership Modal -->
  <div class="modal fade" id="editMembershipModal" tabindex="-1" aria-labelledby="editMembershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editMembershipModalLabel">Edit Membership</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editMembershipForm">
            <div class="mb-3">
              <label for="editMembershipType" class="form-label">Membership Type</label>
              <select class="form-select" id="editMembershipType">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipPrice" class="form-label">Price (₱)</label>
              <input type="number" step="0.01" class="form-control" id="editMembershipPrice" required>
            </div>
            <div class="mb-3">
              <label for="editMembershipPayment" class="form-label">Payment Status</label>
              <select class="form-select" id="editMembershipPayment">
                <option value="paid">Paid</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipStatus" class="form-label">Status</label>
              <select class="form-select" id="editMembershipStatus">
                <option value="active">Active</option>
                <option value="expired">Expired</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipStartDate" class="form-label">Start Date (optional, leave blank to keep current)</label>
              <input type="date" class="form-control" id="editMembershipStartDate">
            </div>
            <div id="editMembershipMsg"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditMembershipBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</body>
</html>
