<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Memberships | InkedInLIFT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header', { title: 'Memberships' }) %>

  <h1>Memberships</h1>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Create membership</h5>
      <form id="createMembershipForm" class="row g-2">
        <div class="col-md-6">
          <input id="memEmail" class="form-control" placeholder="User email" list="emailList" required />
          <datalist id="emailList"></datalist>
        </div>
        <div class="col-md-4">
          <select id="memPlan" class="form-select" required>
            <option value="">Select a membership plan...</option>
            <!-- Plans will be loaded dynamically -->
          </select>
        </div>
        <div class="col-md-1">
          <select id="memPayment" class="form-select"><option value="paid">Paid</option><option value="pending">Pending</option><option value="failed">Failed</option></select>
        </div>
        <div class="col-md-1"><button class="btn btn-primary w-100">Add</button></div>
      </form>
      <div id="planDetails" class="mt-2 small text-muted"></div>
      <div id="createMsg" class="mt-2"></div>
    </div>
  </div>

  <table class="table table-striped" id="membersTable">
    <thead><tr><th>Member</th><th>Plan</th><th>Price (₱)</th><th>Payment</th><th>End</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody>
      <% memberships.forEach(membership => { %>
        <tr data-id="<%= membership._id %>">
          <td><%= membership.user ? (membership.user.firstName || '') + ' ' + (membership.user.lastName || '') : membership.email || 'Unknown' %></td>
          <td><%= membership.membershipType %></td>
          <td>₱<%= membership.price %></td>
          <td><%= membership.paymentStatus %></td>
          <td><%= membership.endDate ? new Date(membership.endDate).toLocaleDateString() : '' %></td>
          <td><%= membership.status %></td>
          <td><button class="btn btn-sm btn-primary editBtn">Edit</button> <button class="btn btn-sm btn-danger delBtn">Delete</button></td>
        </tr>
      <% }); %>
    </tbody>
  </table>

  <nav aria-label="Memberships pagination">
    <ul class="pagination" id="paginationControls">
      <% if (pagination.hasPrev) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">Previous</a>
        </li>
      <% } %>
      <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
        <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
      <% if (pagination.hasNext) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">Next</a>
        </li>
      <% } %>
    </ul>
  </nav>

  <script>
  (async function(){
    function getToken(){ try{ const t=localStorage.getItem("token"); if(t) return t; }catch(e){} const m=document.cookie.match(/(?:^|; )token=([^;]+)/); return m?m[1]:null;}
    const token = getToken();
    const headersAuth = token ? { Authorization: "Bearer " + token } : {};
    const tbody = document.querySelector("#membersTable tbody");

    // Get current page from URL or default to 1
    const urlParams = new URLSearchParams(window.location.search);
    const currentPage = parseInt(urlParams.get('page')) || <%= pagination.currentPage %>;
    const limit = 10; // matches viewRoutes.js

    // Populate email suggestions
    async function populateEmailList() {
      try {
        const res = await fetch("/api/users");
        if (res.ok) {
          const users = await res.json();
          const emails = users.map(u => u.email);
          const datalist = document.getElementById("emailList");
          datalist.innerHTML = emails.map(email => `<option value="${email}">`).join("");
        }
      } catch (err) {
        console.error("Failed to load email suggestions:", err);
      }
    }

    // Load membership plans
    async function loadPlans() {
      try {
        const res = await fetch("/api/membership-plans/plans");
        if (res.ok) {
          const plans = await res.json();
          const planSelect = document.getElementById("memPlan");
          planSelect.innerHTML = '<option value="">Select a membership plan...</option>' +
            plans.map(plan => `<option value="${plan._id}" data-price="${plan.price}" data-duration="${plan.duration}">${plan.name} - ₱${plan.price} (${plan.duration} days)</option>`).join("");
        }
      } catch (err) {
        console.error("Failed to load membership plans:", err);
      }
    }

    populateEmailList();
    loadPlans();

    // Handle plan selection to show details
    document.getElementById("memPlan").addEventListener("change", (e) => {
      const selectedOption = e.target.selectedOptions[0];
      if (selectedOption && selectedOption.value) {
        const price = selectedOption.getAttribute("data-price");
        const duration = selectedOption.getAttribute("data-duration");
        document.getElementById("planDetails").innerText = `₱${price} for ${duration} days`;
      } else {
        document.getElementById("planDetails").innerText = "";
      }
    });

    document.getElementById("createMembershipForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const planId = document.getElementById("memPlan").value;
      if (!planId) {
        alert("Please select a membership plan");
        return;
      }
      const payload = {
        email: document.getElementById("memEmail").value.trim(),
        planId: planId,
        paymentStatus: document.getElementById("memPayment").value
      };
      const res = await fetch("/api/memberships", { method: "POST", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify(payload) });
      const data = await res.json();
      const msg = document.getElementById("createMsg");
      if (!res.ok) { msg.innerText = data.error || data.message || "Failed"; msg.className = "text-danger"; return; }
      msg.innerText = "Created"; msg.className = "text-success";
      document.getElementById("createMembershipForm").reset();
      document.getElementById("planDetails").innerText = "";
      setTimeout(()=> load(), 600);
    });

    async function load(page = currentPage){
      tbody.innerHTML = "<tr><td colspan='7'>Loading…</td></tr>";
      const url = `/api/memberships?page=${page}&limit=${limit}`;
      const res = await fetch(url, { headers: headersAuth });
      if (!res.ok) { tbody.innerHTML = "<tr><td colspan='7'>Failed to load</td></tr>"; return; }
      const items = await res.json();
      tbody.innerHTML = items.map(m => `<tr data-id="${m._id}"><td>${(m.user ? (m.user.firstName||'') + ' ' + (m.user.lastName||'') : (m.email||'Unknown')).trim()}</td><td>${m.membershipType}</td><td>₱${m.price}</td><td>${m.paymentStatus}</td><td>${m.endDate ? new Date(m.endDate).toLocaleDateString() : ''}</td><td>${m.status}</td><td><button class="btn btn-sm btn-danger delBtn">Delete</button> <button class="btn btn-sm btn-primary editBtn">Edit</button></td></tr>`).join("");
      attach();
    }

    function attach(){
      document.querySelectorAll(".delBtn").forEach(b=>b.onclick=async (e)=>{ const id=e.target.closest("tr").dataset.id; if(!confirm("Delete membership?")) return; const res=await fetch("/api/memberships/" + id, { method: "DELETE", headers: headersAuth }); if (res.ok) load(); else alert("Delete failed"); });
      document.querySelectorAll(".editBtn").forEach(b=>b.onclick=async (e)=>{
        const tr=e.target.closest("tr");
        const id=tr.dataset.id;
        const membershipType = tr.children[1].innerText;
        const price = parseFloat(tr.children[2].innerText.replace('₱', ''));
        const paymentStatus = tr.children[3].innerText;
        const endDate = tr.children[4].innerText;
        const status = tr.children[5].innerText;

        // Populate modal
        document.getElementById("editMembershipType").value = membershipType;
        document.getElementById("editMembershipPrice").value = price;
        document.getElementById("editMembershipPayment").value = paymentStatus;
        document.getElementById("editMembershipStatus").value = status;
        document.getElementById("editMembershipStartDate").value = ""; // Optional
        document.getElementById("editMembershipMsg").innerText = "";

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById("editMembershipModal"));
        modal.show();

        // Handle save
        const saveBtn = document.getElementById("saveEditMembershipBtn");
        const handleSave = async () => {
          const payload = {
            membershipType: document.getElementById("editMembershipType").value,
            price: parseFloat(document.getElementById("editMembershipPrice").value),
            paymentStatus: document.getElementById("editMembershipPayment").value,
            status: document.getElementById("editMembershipStatus").value
          };
          const startDate = document.getElementById("editMembershipStartDate").value.trim();
          if (startDate) payload.startDate = startDate;

          const res = await fetch("/api/memberships/" + id, { method: "PUT", headers: { "Content-Type":"application/json", ...headersAuth }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) {
            document.getElementById("editMembershipMsg").innerText = data.error || "Update failed";
            document.getElementById("editMembershipMsg").className = "text-danger";
            return;
          }
          document.getElementById("editMembershipMsg").innerText = "Updated successfully";
          document.getElementById("editMembershipMsg").className = "text-success";
          modal.hide();
          load();
        };

        saveBtn.onclick = handleSave;

        // Clean up event listener when modal is hidden
        document.getElementById("editMembershipModal").addEventListener("hidden.bs.modal", () => {
          saveBtn.onclick = null;
        }, { once: true });
      });
    }

    load();
  })();
  </script>

  <!-- Edit Membership Modal -->
  <div class="modal fade" id="editMembershipModal" tabindex="-1" aria-labelledby="editMembershipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editMembershipModalLabel">Edit Membership</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editMembershipForm">
            <div class="mb-3">
              <label for="editMembershipType" class="form-label">Membership Type</label>
              <select class="form-select" id="editMembershipType">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annual">Annual</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipPrice" class="form-label">Price (₱)</label>
              <input type="number" step="0.01" class="form-control" id="editMembershipPrice" required>
            </div>
            <div class="mb-3">
              <label for="editMembershipPayment" class="form-label">Payment Status</label>
              <select class="form-select" id="editMembershipPayment">
                <option value="paid">Paid</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipStatus" class="form-label">Status</label>
              <select class="form-select" id="editMembershipStatus">
                <option value="active">Active</option>
                <option value="expired">Expired</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editMembershipStartDate" class="form-label">Start Date (optional, leave blank to keep current)</label>
              <input type="date" class="form-control" id="editMembershipStartDate">
            </div>
            <div id="editMembershipMsg"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditMembershipBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
</body>
</html>
